# 💾 Sistema de Persistência de Conversas

## 📋 Resumo

Sistema completo de sincronização de conversas do chatbot com backend Django, permitindo que o usuário acesse seu histórico de conversas em **diferentes dispositivos**.

---

## 🎯 Funcionalidades Implementadas

### 1. **Persistência no Backend**
- ✅ Conversas armazenadas no banco de dados PostgreSQL
- ✅ Sincronização automática ao enviar mensagens
- ✅ Carregamento automático ao fazer login
- ✅ Acesso multi-dispositivo (Web, Mobile, Tablet)

### 2. **Endpoints REST API**

#### **Conversas**
```
GET    /api/ai/conversations/              # Listar todas as conversas
POST   /api/ai/conversations/              # Criar nova conversa
GET    /api/ai/conversations/{id}/         # Detalhes de uma conversa
PATCH  /api/ai/conversations/{id}/         # Atualizar título/metadados
DELETE /api/ai/conversations/{id}/         # Deletar conversa (soft delete)
POST   /api/ai/conversations/{id}/add_message/  # Adicionar mensagem
```

#### **Mensagens**
```
GET    /api/ai/messages/                   # Listar mensagens
GET    /api/ai/messages/{id}/              # Detalhes de uma mensagem
PATCH  /api/ai/messages/{id}/              # Editar mensagem
DELETE /api/ai/messages/{id}/              # Deletar mensagem
```

---

## 🏗️ Arquitetura

### **Backend (Django)**

#### Models
```python
AIConversation
├── id: int
├── user: ForeignKey(User)
├── title: str
├── conversation_type: str (general, agriculture, pest_analysis)
├── model_used: str
├── created_at: datetime
├── updated_at: datetime
└── is_active: bool

AIMessage
├── id: int
├── conversation: ForeignKey(AIConversation)
├── role: str (user, assistant, system)
├── content: text
├── timestamp: datetime
├── metadata: JSONField (para content_html, etc)
└── token_usage: JSONField
```

#### ViewSets
```python
AIConversationViewSet
├── get_queryset()          # Filtra por usuário
├── perform_create()        # Associa ao usuário
├── perform_destroy()       # Soft delete
└── add_message()           # Action customizada

AIMessageViewSet
├── get_queryset()          # Filtra por conversas do usuário
└── perform_create()        # Valida propriedade da conversa
```

---

### **Frontend (Next.js)**

#### Funções de Sincronização

```typescript
loadConversationsFromBackend()
// Carrega todas as conversas ao fazer login
// Converte formato backend → frontend
// Define conversa ativa

createNewConversationInBackend()
// Cria conversa no backend via POST
// Atualiza estado local
// Fallback para criação local em caso de erro

saveMessageToBackend(conversationId, role, content, contentHtml?)
// Salva mensagem via POST
// Retorna ID da mensagem salva
// Associa ID ao estado local

deleteConversationFromBackend(conversationId)
// Deleta conversa (soft delete)
// Remove do estado local

updateConversationTitle(conversationId, title)
// Atualiza título via PATCH
// Sincroniza com backend
```

#### Fluxo de Envio de Mensagem

```
1. Usuário digita mensagem
2. saveMessageToBackend(conversationId, 'user', content)
3. Recebe ID da mensagem do backend
4. Envia para streaming endpoint
5. Recebe resposta da IA
6. saveMessageToBackend(conversationId, 'assistant', response, responseHtml)
7. Atualiza título se for primeira mensagem
8. updateConversationTitle(conversationId, autoGeneratedTitle)
```

---

## 📡 Formato de Dados

### **Backend → Frontend**
```json
{
  "id": 123,
  "title": "Consulta sobre pragas",
  "conversation_type": "pest_analysis",
  "created_at": "2025-01-26T10:30:00Z",
  "updated_at": "2025-01-26T11:45:00Z",
  "messages": [
    {
      "id": 456,
      "role": "user",
      "content": "Como combater lagarta do cartucho?",
      "timestamp": "2025-01-26T10:30:00Z",
      "metadata": {}
    },
    {
      "id": 457,
      "role": "assistant",
      "content": "Recomendo usar Bacillus thuringiensis...",
      "timestamp": "2025-01-26T10:30:15Z",
      "metadata": {
        "content_html": "<p>Recomendo usar <strong>Bacillus thuringiensis</strong>...</p>"
      }
    }
  ]
}
```

### **Frontend → Backend (Criar Conversa)**
```json
{
  "title": "Nova Conversa",
  "conversation_type": "general"
}
```

### **Frontend → Backend (Adicionar Mensagem)**
```json
{
  "role": "user",
  "content": "Qual é a melhor época para plantar milho?",
  "metadata": {}
}
```

---

## 🔒 Segurança

1. **Autenticação JWT**: Todas as requisições exigem token
2. **Filtro por Usuário**: ViewSets filtram automaticamente por `request.user`
3. **Validação de Propriedade**: Impede acesso a conversas de outros usuários
4. **Soft Delete**: Conversas deletadas mantêm `is_active=False`

---

## 🧪 Como Testar

### **Teste 1: Persistência Básica**
```bash
1. Login no chatbot
2. Enviar mensagem: "Olá!"
3. Recarregar página (F5)
4. ✅ Verificar que mensagem ainda está lá
```

### **Teste 2: Multi-Dispositivo**
```bash
1. Login no desktop: http://localhost:3000/chatbot
2. Enviar mensagem: "Testando multi-device"
3. Abrir em outro navegador/aba privada
4. Login com mesma conta
5. ✅ Verificar que conversa está sincronizada
```

### **Teste 3: Criação/Exclusão**
```bash
1. Criar 3 conversas diferentes
2. Enviar mensagens em cada uma
3. Deletar uma conversa
4. Recarregar página
5. ✅ Verificar que 2 conversas permanecem
```

### **Teste 4: Edição de Mensagens**
```bash
1. Enviar mensagem: "Texto original"
2. Clicar em Editar
3. Alterar para: "Texto editado"
4. Salvar
5. Recarregar página
6. ✅ Verificar que edição foi persistida
```

---

## 📊 Vantagens da Implementação

| Aspecto | Antes | Depois |
|---------|-------|--------|
| **Armazenamento** | localStorage (local) | PostgreSQL (servidor) |
| **Multi-dispositivo** | ❌ Não | ✅ Sim |
| **Perda de dados** | ❌ Limpar cache = perder tudo | ✅ Dados seguros no servidor |
| **Sincronização** | ❌ Manual | ✅ Automática |
| **Backup** | ❌ Não | ✅ Banco de dados |
| **Analytics** | ❌ Difícil | ✅ Fácil (queries SQL) |

---

## 🚀 Melhorias Futuras

- [ ] **Sincronização em tempo real** (WebSocket)
- [ ] **Compartilhamento de conversas** (link público)
- [ ] **Busca full-text** nas conversas
- [ ] **Exportar conversas** (PDF, JSON)
- [ ] **Tags/categorias** personalizadas
- [ ] **Favoritar conversas** importantes
- [ ] **Arquivar conversas** antigas
- [ ] **Estatísticas de uso** (dashboard)

---

## 🛠️ Troubleshooting

### **Conversas não carregam ao login**
```bash
# Verificar token JWT
console.log(localStorage.getItem('token'))

# Verificar endpoint
curl -H "Authorization: Bearer {token}" \
  http://localhost:8000/api/ai/conversations/
```

### **Erro ao salvar mensagem**
```bash
# Verificar que conversa existe e pertence ao usuário
# Ver console do navegador (F12)
# Ver logs do Django (terminal backend)
```

### **Duplicação de conversas**
```bash
# Limpar localStorage antigo
localStorage.removeItem('agroalerta_conversations')
localStorage.removeItem('agroalerta_active_conversation')
# Recarregar página
```

---

## 📝 Arquivos Modificados

### **Backend**
- ✅ `backend/ai/models.py` - Models já existiam
- ✅ `backend/ai/views.py` - Adicionados ViewSets
- ✅ `backend/ai/urls.py` - Configurado Router
- ✅ `backend/ai/serializers.py` - Já existiam

### **Frontend**
- ✅ `frontend/src/app/chatbot/page.tsx` - Funções de sincronização
- ✅ Removido uso de localStorage para persistência
- ✅ Integrado com endpoints REST

---

## ✅ Status

**Sistema 100% Funcional!** 

O histórico de conversas agora é **persistente**, **sincronizado** e **acessível de qualquer dispositivo**. 🎉
