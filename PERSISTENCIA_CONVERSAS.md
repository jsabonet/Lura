# ğŸ’¾ Sistema de PersistÃªncia de Conversas

## ğŸ“‹ Resumo

Sistema completo de sincronizaÃ§Ã£o de conversas do chatbot com backend Django, permitindo que o usuÃ¡rio acesse seu histÃ³rico de conversas em **diferentes dispositivos**.

---

## ğŸ¯ Funcionalidades Implementadas

### 1. **PersistÃªncia no Backend**
- âœ… Conversas armazenadas no banco de dados PostgreSQL
- âœ… SincronizaÃ§Ã£o automÃ¡tica ao enviar mensagens
- âœ… Carregamento automÃ¡tico ao fazer login
- âœ… Acesso multi-dispositivo (Web, Mobile, Tablet)

### 2. **Endpoints REST API**

#### **Conversas**
```
GET    /api/ai/conversations/              # Listar todas as conversas
POST   /api/ai/conversations/              # Criar nova conversa
GET    /api/ai/conversations/{id}/         # Detalhes de uma conversa
PATCH  /api/ai/conversations/{id}/         # Atualizar tÃ­tulo/metadados
DELETE /api/ai/conversations/{id}/         # Deletar conversa (soft delete)
POST   /api/ai/conversations/{id}/add_message/  # Adicionar mensagem
```

#### **Mensagens**
```
GET    /api/ai/messages/                   # Listar mensagens
GET    /api/ai/messages/{id}/              # Detalhes de uma mensagem
PATCH  /api/ai/messages/{id}/              # Editar mensagem
DELETE /api/ai/messages/{id}/              # Deletar mensagem
```

---

## ğŸ—ï¸ Arquitetura

### **Backend (Django)**

#### Models
```python
AIConversation
â”œâ”€â”€ id: int
â”œâ”€â”€ user: ForeignKey(User)
â”œâ”€â”€ title: str
â”œâ”€â”€ conversation_type: str (general, agriculture, pest_analysis)
â”œâ”€â”€ model_used: str
â”œâ”€â”€ created_at: datetime
â”œâ”€â”€ updated_at: datetime
â””â”€â”€ is_active: bool

AIMessage
â”œâ”€â”€ id: int
â”œâ”€â”€ conversation: ForeignKey(AIConversation)
â”œâ”€â”€ role: str (user, assistant, system)
â”œâ”€â”€ content: text
â”œâ”€â”€ timestamp: datetime
â”œâ”€â”€ metadata: JSONField (para content_html, etc)
â””â”€â”€ token_usage: JSONField
```

#### ViewSets
```python
AIConversationViewSet
â”œâ”€â”€ get_queryset()          # Filtra por usuÃ¡rio
â”œâ”€â”€ perform_create()        # Associa ao usuÃ¡rio
â”œâ”€â”€ perform_destroy()       # Soft delete
â””â”€â”€ add_message()           # Action customizada

AIMessageViewSet
â”œâ”€â”€ get_queryset()          # Filtra por conversas do usuÃ¡rio
â””â”€â”€ perform_create()        # Valida propriedade da conversa
```

---

### **Frontend (Next.js)**

#### FunÃ§Ãµes de SincronizaÃ§Ã£o

```typescript
loadConversationsFromBackend()
// Carrega todas as conversas ao fazer login
// Converte formato backend â†’ frontend
// Define conversa ativa

createNewConversationInBackend()
// Cria conversa no backend via POST
// Atualiza estado local
// Fallback para criaÃ§Ã£o local em caso de erro

saveMessageToBackend(conversationId, role, content, contentHtml?)
// Salva mensagem via POST
// Retorna ID da mensagem salva
// Associa ID ao estado local

deleteConversationFromBackend(conversationId)
// Deleta conversa (soft delete)
// Remove do estado local

updateConversationTitle(conversationId, title)
// Atualiza tÃ­tulo via PATCH
// Sincroniza com backend
```

#### Fluxo de Envio de Mensagem

```
1. UsuÃ¡rio digita mensagem
2. saveMessageToBackend(conversationId, 'user', content)
3. Recebe ID da mensagem do backend
4. Envia para streaming endpoint
5. Recebe resposta da IA
6. saveMessageToBackend(conversationId, 'assistant', response, responseHtml)
7. Atualiza tÃ­tulo se for primeira mensagem
8. updateConversationTitle(conversationId, autoGeneratedTitle)
```

---

## ğŸ“¡ Formato de Dados

### **Backend â†’ Frontend**
```json
{
  "id": 123,
  "title": "Consulta sobre pragas",
  "conversation_type": "pest_analysis",
  "created_at": "2025-01-26T10:30:00Z",
  "updated_at": "2025-01-26T11:45:00Z",
  "messages": [
    {
      "id": 456,
      "role": "user",
      "content": "Como combater lagarta do cartucho?",
      "timestamp": "2025-01-26T10:30:00Z",
      "metadata": {}
    },
    {
      "id": 457,
      "role": "assistant",
      "content": "Recomendo usar Bacillus thuringiensis...",
      "timestamp": "2025-01-26T10:30:15Z",
      "metadata": {
        "content_html": "<p>Recomendo usar <strong>Bacillus thuringiensis</strong>...</p>"
      }
    }
  ]
}
```

### **Frontend â†’ Backend (Criar Conversa)**
```json
{
  "title": "Nova Conversa",
  "conversation_type": "general"
}
```

### **Frontend â†’ Backend (Adicionar Mensagem)**
```json
{
  "role": "user",
  "content": "Qual Ã© a melhor Ã©poca para plantar milho?",
  "metadata": {}
}
```

---

## ğŸ”’ SeguranÃ§a

1. **AutenticaÃ§Ã£o JWT**: Todas as requisiÃ§Ãµes exigem token
2. **Filtro por UsuÃ¡rio**: ViewSets filtram automaticamente por `request.user`
3. **ValidaÃ§Ã£o de Propriedade**: Impede acesso a conversas de outros usuÃ¡rios
4. **Soft Delete**: Conversas deletadas mantÃªm `is_active=False`

---

## ğŸ§ª Como Testar

### **Teste 1: PersistÃªncia BÃ¡sica**
```bash
1. Login no chatbot
2. Enviar mensagem: "OlÃ¡!"
3. Recarregar pÃ¡gina (F5)
4. âœ… Verificar que mensagem ainda estÃ¡ lÃ¡
```

### **Teste 2: Multi-Dispositivo**
```bash
1. Login no desktop: http://localhost:3000/chatbot
2. Enviar mensagem: "Testando multi-device"
3. Abrir em outro navegador/aba privada
4. Login com mesma conta
5. âœ… Verificar que conversa estÃ¡ sincronizada
```

### **Teste 3: CriaÃ§Ã£o/ExclusÃ£o**
```bash
1. Criar 3 conversas diferentes
2. Enviar mensagens em cada uma
3. Deletar uma conversa
4. Recarregar pÃ¡gina
5. âœ… Verificar que 2 conversas permanecem
```

### **Teste 4: EdiÃ§Ã£o de Mensagens**
```bash
1. Enviar mensagem: "Texto original"
2. Clicar em Editar
3. Alterar para: "Texto editado"
4. Salvar
5. Recarregar pÃ¡gina
6. âœ… Verificar que ediÃ§Ã£o foi persistida
```

---

## ğŸ“Š Vantagens da ImplementaÃ§Ã£o

| Aspecto | Antes | Depois |
|---------|-------|--------|
| **Armazenamento** | localStorage (local) | PostgreSQL (servidor) |
| **Multi-dispositivo** | âŒ NÃ£o | âœ… Sim |
| **Perda de dados** | âŒ Limpar cache = perder tudo | âœ… Dados seguros no servidor |
| **SincronizaÃ§Ã£o** | âŒ Manual | âœ… AutomÃ¡tica |
| **Backup** | âŒ NÃ£o | âœ… Banco de dados |
| **Analytics** | âŒ DifÃ­cil | âœ… FÃ¡cil (queries SQL) |

---

## ğŸš€ Melhorias Futuras

- [ ] **SincronizaÃ§Ã£o em tempo real** (WebSocket)
- [ ] **Compartilhamento de conversas** (link pÃºblico)
- [ ] **Busca full-text** nas conversas
- [ ] **Exportar conversas** (PDF, JSON)
- [ ] **Tags/categorias** personalizadas
- [ ] **Favoritar conversas** importantes
- [ ] **Arquivar conversas** antigas
- [ ] **EstatÃ­sticas de uso** (dashboard)

---

## ğŸ› ï¸ Troubleshooting

### **Conversas nÃ£o carregam ao login**
```bash
# Verificar token JWT
console.log(localStorage.getItem('token'))

# Verificar endpoint
curl -H "Authorization: Bearer {token}" \
  http://localhost:8000/api/ai/conversations/
```

### **Erro ao salvar mensagem**
```bash
# Verificar que conversa existe e pertence ao usuÃ¡rio
# Ver console do navegador (F12)
# Ver logs do Django (terminal backend)
```

### **DuplicaÃ§Ã£o de conversas**
```bash
# Limpar localStorage antigo
localStorage.removeItem('agroalerta_conversations')
localStorage.removeItem('agroalerta_active_conversation')
# Recarregar pÃ¡gina
```

---

## ğŸ“ Arquivos Modificados

### **Backend**
- âœ… `backend/ai/models.py` - Models jÃ¡ existiam
- âœ… `backend/ai/views.py` - Adicionados ViewSets
- âœ… `backend/ai/urls.py` - Configurado Router
- âœ… `backend/ai/serializers.py` - JÃ¡ existiam

### **Frontend**
- âœ… `frontend/src/app/chatbot/page.tsx` - FunÃ§Ãµes de sincronizaÃ§Ã£o
- âœ… Removido uso de localStorage para persistÃªncia
- âœ… Integrado com endpoints REST

---

## âœ… Status

**Sistema 100% Funcional!** 

O histÃ³rico de conversas agora Ã© **persistente**, **sincronizado** e **acessÃ­vel de qualquer dispositivo**. ğŸ‰
